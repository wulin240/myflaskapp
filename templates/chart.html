<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>{{ stock_id }} Kç·šåœ–</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 0; }
.header { text-align: center; padding: 10px; background-color: #f0f0f0; }
.chart-container { padding: 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; touch-action: pan-x pan-y; }
.chart-inner { min-width: 900px; width: 100%; }
a { text-decoration: none; color: blue; }
.draw-panel { position: absolute; top: 10px; right: 10px; background: rgba(240,240,240,0.9); padding: 5px; border-radius: 5px; font-size: 14px; z-index: 10; }
select, input, button { margin: 2px; padding: 2px; font-size: 12px; }
#hoverInfo { position: absolute; background: rgba(255,255,255,0.95); border: 1px solid #ccc; padding: 5px 8px; border-radius: 5px; display: none; font-size: 13px; pointer-events: none; z-index: 20; }
#stockIndexDisplay { position: absolute; top: 10px; left: 10px; background: rgba(240,240,240,0.9); padding: 5px 8px; border-radius: 5px; font-size: 14px; z-index: 10; }
#favoriteBtn { padding:6px 10px; border:none; cursor:pointer; }
</style>
</head>
<body>

<div class="header">
<h2>{{ stock_id }} Kç·šåœ–</h2>
<a href="/">è¿”å›é¦–é </a>
</div>

<!-- å¿«æ·ç­†æ•¸æŒ‰éˆ• -->
<div style="text-align:center; margin:5px 0;">
  {% for n in [30,60,90,120] %}
    <button onclick="changeNumRows({{ n }})">{{ n }} ç­†</button>
  {% endfor %}
</div>

<div id="stockIndexDisplay"></div>

<div class="draw-panel">
ç·šæ¢é¡è‰²ï¼š
<select id="lineColor">
<option value="red" selected>ç´…</option>
<option value="blue">è—</option>
<option value="green">ç¶ </option>
<option value="black">é»‘</option>
</select>
ç·šå¯¬ï¼š
<input type="number" id="lineWidth" value="2" min="1" max="10" style="width:40px;">
<button onclick="updateDrawSettings()">æ›´æ–°</button>
<button id="toggleDraw" style="background:#ddd;">ğŸ“± é–‹å•Ÿç•«ç­†</button>
<button id="toggleMA" style="background:#ddd;">åˆ‡æ›å‡ç·šé¡¯ç¤º</button>
<button id="clearDraw" style="background:#ffdddd;">ğŸ§¹ æ¸…é™¤ç¹ªåœ–</button>
</div>

<button id="prevStock" style="background:#ddd;">â¬…ï¸ ä¸Šä¸€ç­†</button>
<button id="nextStock" style="background:#ddd;">ä¸‹ä¸€ç­† â¡ï¸</button>
<button id="favoriteBtn">â­ åŠ å…¥æœ€æ„›</button>

<div class="chart-container">
<div class="chart-inner">
{{ chart_html | safe }}
</div>
</div>

<div id="hoverInfo"></div>

<script>
// ----------- ç•«ç­† & å‡ç·š & æ¸…é™¤ -----------
let penEnabled = false;

function updateDrawSettings() {
    const color = document.getElementById("lineColor").value;
    const width = parseInt(document.getElementById("lineWidth").value);
    const gd = document.querySelector(".plotly-graph-div");
    Plotly.relayout(gd, {'newshape.line.color': color,'newshape.line.width': width});
}

function toggleMA() {
    const gd = document.querySelector(".plotly-graph-div");
    let maVisible = localStorage.getItem("maVisible");
    if(maVisible === null) maVisible = 'true';
    maVisible = maVisible === 'true' ? 'false' : 'true';
    localStorage.setItem("maVisible", maVisible);

    gd.data.forEach((trace,i)=>{
        if(trace.name && (trace.name.includes('MA') || trace.name.includes('æ­¢æ'))){
            const visible = maVisible === 'true' ? true : 'legendonly';
            Plotly.restyle(gd, {'visible': visible}, [i]);
        }
    });
}

// åˆå§‹åŒ–æ™‚ï¼Œæ ¹æ“š localStorage è¨­å®šå‡ç·šå’Œæ­¢æç·šé¡¯ç¤º
document.addEventListener("DOMContentLoaded", function(){
    const gd = document.querySelector(".plotly-graph-div");
    let maVisible = localStorage.getItem("maVisible");
    if(maVisible === null) maVisible = 'true';
    gd.data.forEach((trace,i)=>{
        if(trace.name && (trace.name.includes('MA') || trace.name.includes('æ­¢æ'))){
            const visible = maVisible === 'true' ? true : 'legendonly';
            Plotly.restyle(gd, {'visible': visible}, [i]);
        }
    });
});

function clearDrawings(){
    const gd = document.querySelector(".plotly-graph-div");
    Plotly.relayout(gd,{'shapes':[]});
}

// ----------- åˆå§‹åŒ– -----------
document.addEventListener("DOMContentLoaded", function(){
    const gd = document.querySelector(".plotly-graph-div");
    const hoverBox = document.getElementById("hoverInfo");
    const toggleBtn = document.getElementById("toggleDraw");
    const toggleMABtn = document.getElementById("toggleMA");
    const clearBtn = document.getElementById("clearDraw");
    const stockIndexDisplay = document.getElementById("stockIndexDisplay");

    toggleMABtn.addEventListener("click", toggleMA);
    clearBtn.addEventListener("click", clearDrawings);

    // é¡¯ç¤ºç›®å‰ç¬¬å¹¾ç­†
    function updateStockIndexDisplay(){
        stockIndexDisplay.textContent = `${currentIndex+1}/${stockList.length}`;
    }
    updateStockIndexDisplay();

    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
    if(isMobile){
        Plotly.relayout(gd,{dragmode:false});
        toggleBtn.addEventListener("click", ()=>{
            penEnabled = !penEnabled;
            if(penEnabled){
                Plotly.relayout(gd,{dragmode:'drawline'});
                toggleBtn.textContent="ğŸ“± é—œé–‰ç•«ç­†";
                toggleBtn.style.background="#c0ffc0";
            }else{
                Plotly.relayout(gd,{dragmode:false});
                toggleBtn.textContent="ğŸ“± é–‹å•Ÿç•«ç­†";
                toggleBtn.style.background="#ddd";
            }
        });

        gd.on('plotly_click', function(data){
            if(!data.points || !data.points.length) return;
            const pt = data.points[0];
            hoverBox.innerHTML = `${pt.data.name || ''}<br>${pt.x}<br>${pt.y}`;
            hoverBox.style.left=(data.event.clientX+10)+'px';
            hoverBox.style.top=(data.event.clientY-20)+'px';
            hoverBox.style.display='block';
            setTimeout(()=>hoverBox.style.display='none',2500);
        });
    }else{
        gd.on('plotly_hover', function(data){
            const pt = data.points[0];
            hoverBox.innerHTML = `${pt.data.name || ''}<br>${pt.x}<br>${pt.y}`;
            hoverBox.style.left=(data.event.clientX+10)+'px';
            hoverBox.style.top=(data.event.clientY-20)+'px';
            hoverBox.style.display='block';
        });
        gd.on('plotly_unhover', function(){hoverBox.style.display='none';});
    }

    // ----------- æœ€æ„›æŒ‰éˆ•åˆå§‹åŒ– -----------
    const favoriteBtn = document.getElementById("favoriteBtn");
    let isFavorite = {{ 'true' if is_favorite else 'false' }};
    function updateFavoriteButton(){
        if(isFavorite){
            favoriteBtn.style.backgroundColor='green';
            favoriteBtn.style.color='white';
            favoriteBtn.textContent='â­ å·²åŠ å…¥æœ€æ„›';
        }else{
            favoriteBtn.style.backgroundColor='#ffd700';
            favoriteBtn.style.color='black';
            favoriteBtn.textContent='â­ åŠ å…¥æœ€æ„›';
        }
    }
    updateFavoriteButton();

    favoriteBtn.addEventListener("click", async ()=>{
        try{
            const res = await fetch("/favorite",{
                method:"POST",
                headers:{"Content-Type":"application/x-www-form-urlencoded"},
                body:`stock_id=${encodeURIComponent("{{ stock_id }}")}&stock_name=${encodeURIComponent("{{ stock_id }}")}`
            });
            const data = await res.json();
            if(data.favorite !== undefined) isFavorite = data.favorite;
            updateFavoriteButton();
            alert(data.message);
        }catch(e){
            alert("æ“ä½œæœ€æ„›å¤±æ•—");
            console.error(e);
        }
    });
});

// ----------- ä¸Šä¸‹ç­†åˆ‡æ› -----------
const stockList = "{{ stock_list }}".split(',');
let currentIndex = parseInt("{{ current_index }}");

document.getElementById("prevStock").addEventListener("click", ()=>{
    if(currentIndex>0) currentIndex--;
    location.href=`/chart/${stockList[currentIndex]}?list=${stockList.join(',')}&index=${currentIndex}&num_rows={{ num_rows }}&simple_mode={{ '1' if simple_mode else '0' }}`;
});

document.getElementById("nextStock").addEventListener("click", ()=>{
    if(currentIndex<stockList.length-1) currentIndex++;
    location.href=`/chart/${stockList[currentIndex]}?list=${stockList.join(',')}&index=${currentIndex}&num_rows={{ num_rows }}&simple_mode={{ '1' if simple_mode else '0' }}`;
});

// ----------- å¿«æ·ç­†æ•¸æŒ‰éˆ• -----------
{% if stock_list|length > 1 %}
function changeNumRows(n){
    const simpleMode = "{{ '1' if simple_mode else '0' }}";
    const url = `/chart/{{ stock_id }}?num_rows=${n}&simple_mode=${simpleMode}&list={{ stock_list }}&index={{ current_index }}`;
    window.location.href = url;
}
{% else %}
function changeNumRows(n){
    const stockId = "{{ stock_id }}";
    const simpleMode = "{{ '1' if simple_mode else '0' }}";
    const url = `/chart/${stockId}?num_rows=${n}&simple_mode=${simpleMode}`;
    window.location.href = url;
}
{% endif %}
</script>

</body>
</html>
