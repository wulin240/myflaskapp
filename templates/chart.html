<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>{{ stock_id }} Kç·šåœ–</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* --- CSS æ¨£å¼ (å¤§éƒ¨åˆ†ä¸è®Š) --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #ffffff;
            color: #333;
        }

        .header {
            text-align: center;
            padding: 15px 10px;
            background-color: #f0f0f0;
            border-bottom: 2px solid #ddd;
        }

        .header h2 {
            margin: 0;
            color: #0056b3;
        }
        
        /* ------------------- ğŸŒŸ è·‘é¦¬ç‡ˆå°ˆç”¨ CSS ä¿®æ­£ ------------------- */
        
        #noteMarquee {
            background-color: #ffeaa7; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
            color: #333;
            padding: 5px 10px;
            font-size: 16px; /* ğŸŒŸ å­—é«”åŠ å¤§ */
            border-bottom: 1px solid #f9d863;
            overflow: hidden; /* éš±è—è¶…å‡ºå®¹å™¨çš„å…§å®¹ */
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative; /* ç”¨æ–¼å®šä½å‹•ç•«å…§å®¹ */
            height: 30px; /* ç¢ºä¿é«˜åº¦è¶³å¤  */
            line-height: 20px;
        }
        
        #marqueeContent {
            display: inline-block;
            white-space: nowrap;
            position: absolute; /* ç›¸å°æ–¼çˆ¶å®¹å™¨å®šä½ */
            padding-left: 100%; /* è®“å…§å®¹å¾æœ€å³é‚Šé–‹å§‹ */
            /* æ‡‰ç”¨ CSS è·‘é¦¬ç‡ˆå‹•ç•« */
            animation: marquee 20s linear infinite; /* 20ç§’è·‘å®Œä¸€åœˆï¼Œç„¡é™å¾ªç’° */
        }
        
        #marqueeContent span {
            font-weight: bold;
            color: #d35400; /* çªé¡¯å‚™è¨»æ¨™ç±¤ */
            margin-right: 15px;
            font-size: 1.1em; /* è®“æ¨™ç±¤æ›´æ˜é¡¯ */
        }
        
        /* CSS è·‘é¦¬ç‡ˆå‹•ç•«å®šç¾© */
        @keyframes marquee {
            0% { transform: translate(0, 0); } /* å¾æœ€å³é‚Šé–‹å§‹ (å› ç‚º padding-left: 100%) */
            100% { transform: translate(-100%, 0); } /* æ»¾å‹•åˆ°æœ€å·¦é‚Š */
        }
        /* ------------------- ğŸŒŸ è·‘é¦¬ç‡ˆå°ˆç”¨ CSS ä¿®æ­£ END ------------------- */


        /* ğŸŒŸ é ‚éƒ¨ä¿¡è™Ÿé¡¯ç¤ºå€å¡Šæ¨£å¼ */
        #signalDisplay {
            text-align: center;
            padding: 15px 10px;
            background-color: #fefefe;
            border-bottom: 1px solid #ddd;
            font-size: 1.1em;
            line-height: 1.8;
            font-weight: 500;
        }

        #signalDisplay strong {
            color: #555;
            font-size: 1.05em;
        }

        /* ... (çœç•¥ä¸­é–“ä¸è®Šçš„æ¨£å¼) ... */

        .control-panel {
            padding: 8px 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            gap: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* å‚™è¨»è¼¸å…¥æ¡†çš„æ¨£å¼ */
        #noteGroup {
            flex-grow: 1;
            max-width: 400px;
            min-width: 200px;
        }
        #noteInput {
            flex-grow: 1;
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* ... (çœç•¥å…¶é¤˜ä¸è®Šçš„æ¨£å¼) ... */
    </style>
</head>
<body>

    <div class="header">
        <h2>{{ stock_id }} Kç·šåœ–</h2>
        <a href="/">è¿”å›é¦–é </a>
    </div>

    <div id="noteMarquee" style="display: none;">
        <div id="marqueeContent">
            </div>
    </div>

    <div id="stockIndexDisplay"></div>
    
    <div id="signalDisplay">
        <strong>è¶¨å‹¢åˆ†æ:</strong>
        <span id="trendDesc" class="{{ trend_class }}">{{ trend_desc | safe }}</span><br>
        <strong>ä¿¡è™Ÿæª¢æŸ¥:</strong>
        <span id="reboundDesc">{{ rebound_desc | safe }}</span>
    </div>

    <div class="control-panel">

        <div class="control-group">
            <button id="prevStock" style="background:#ddd;">â¬…ï¸ ä¸Šä¸€ç­†</button>
            <button id="nextStock" style="background:#ddd;">ä¸‹ä¸€ç­† â¡ï¸</button>
            <button id="favoriteBtn">â­ åŠ å…¥æœ€æ„›</button>
        </div>

        <div class="control-group" id="noteGroup">
            <label for="noteInput" style="white-space: nowrap;">å‚™è¨»:</label>
            <input type="text" id="noteInput" placeholder="è¼¸å…¥å‚™è¨»ï¼Œå„²å­˜å¾Œè‡ªå‹•å¯«å…¥" value="{{ favorite_note | default('') }}">
        </div>

        <div class="control-group">
            <label for="frequencySelect">é€±æœŸ:</label>
            <select id="frequencySelect" onchange="changeFrequency(this.value)">
                <option value="D" {% if frequency == 'D' %}selected{% endif %}>æ—¥ç·š (D)</option>
                <option value="W" {% if frequency == 'W' %}selected{% endif %}>é€±ç·š (W)</option>
            </select>

            {% for n in [30,60,90,120] %}
            <button onclick="changeNumRows({{ n }})" {% if num_rows == n %}style="background-color:#c0c0ff"{% endif %}>{{ n }} ç­†</button>
            {% endfor %}
        </div>

        <div class="draw-panel">
            ç·šæ¢é¡è‰²ï¼š
            <select id="lineColor">
                <option value="red" selected>ç´…</option>
                <option value="blue">è—</option>
                <option value="green">ç¶ </option>
                <option value="black">é»‘</option>
            </select>
            ç·šå¯¬ï¼š
            <input type="number" id="lineWidth" value="2" min="1" max="10" style="width:40px;">
            <button onclick="updateDrawSettings()">æ›´æ–°</button>
            <button id="toggleDraw" style="background:#c0ffc0;">ğŸ“± é—œé–‰ç•«ç­†</button>
            <button id="toggleMA" style="background:#ddd;">åˆ‡æ›å‡ç·šé¡¯ç¤º</button>
            <button id="clearDraw" style="background:#ffdddd;">ğŸ§¹ æ¸…é™¤ç¹ªåœ–</button>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-inner">
            {{ chart_html | safe }}
        </div>
    </div>

    <div id="hoverInfo"></div>

    <script>
        // å¾ Flask ç²å–è®Šæ•¸
        const stockList = "{{ stock_list }}".split(',');
        let currentIndex = parseInt("{{ current_index }}");
        let currentNumRows = parseInt("{{ num_rows }}");
        let simpleMode = "{{ '1' if simple_mode else '0' }}";
        let currentFrequency = "{{ frequency }}";
        let trendDescText = "{{ trend_desc | safe }}".trim();
        let reboundDescText = "{{ rebound_desc | safe }}".trim();
        let trendClass = "{{ trend_class }}";
        // ğŸŒŸ ç²å–å¾Œç«¯å‚³ä¾†çš„å‚™è¨»
        const initialNote = "{{ favorite_note | default('') }}";

        // ---------------------- æ ¸å¿ƒå‡½æ•¸ (ä¸è®Š) ----------------------
        function buildUrl(stockId, index, numRows, simpleMode, frequency) {
            const listParam = stockList.join(',');
            let url = `/chart/${stockId}?num_rows=${numRows}&simple_mode=${simpleMode}&frequency=${frequency}`;
            if (listParam) {
                url += `&list=${listParam}&index=${index}`;
            }
            return url;
        }
        // ... (çœç•¥ä¸­é–“ä¸è®Šçš„å°èˆªå‡½æ•¸) ...
        function changeFrequency(newFreq) {
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                newFreq
            );
        }

        function changeNumRows(n) {
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                n,
                simpleMode,
                currentFrequency
            );
        }

        document.getElementById("prevStock").addEventListener("click", () => {
            if (currentIndex > 0) currentIndex--;
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                currentFrequency
            );
        });

        document.getElementById("nextStock").addEventListener("click", () => {
            if (currentIndex < stockList.length - 1) currentIndex++;
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                currentFrequency
            );
        });
        
        // ... (ç¹ªåœ–ã€å‡ç·šã€æ¸…é™¤ã€ä¿¡è™Ÿæ¨£å¼ç­‰é‚è¼¯ä¸è®Š) ...


        // ------------------ ğŸŒŸ åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ------------------
        document.addEventListener("DOMContentLoaded", function () {
            const gd = document.querySelector(".plotly-graph-div");
            const toggleMABtn = document.getElementById("toggleMA");
            const clearBtn = document.getElementById("clearDraw");
            const stockIndexDisplay = document.getElementById("stockIndexDisplay");
            const favoriteBtn = document.getElementById("favoriteBtn");
            const noteInput = document.getElementById("noteInput");
            
            // ğŸŒŸ è·‘é¦¬ç‡ˆå…ƒç´ 
            const noteMarqueeDiv = document.getElementById("noteMarquee");
            const marqueeContent = document.getElementById("marqueeContent");
            
            
            // ------------------ ğŸŒŸ è·‘é¦¬ç‡ˆåˆå§‹åŒ–åŠæ›´æ–°å‡½æ•¸ ------------------
            function updateMarquee(note) {
                const trimmedNote = note.trim();
                if (trimmedNote.length > 0) {
                    // ğŸŒŸ æ³¨æ„ï¼šæˆ‘å€‘å°‡æ•´å€‹å…§å®¹æ”¾å…¥ marqueeContent ä¸­
                    marqueeContent.innerHTML = `<span>æˆ‘çš„å‚™è¨»:</span> ${trimmedNote}`;
                    noteMarqueeDiv.style.display = 'block';
                    // é‡æ–°æ‡‰ç”¨å‹•ç•« (ç‚ºäº†ç¢ºä¿åœ¨å…§å®¹æ›´æ–°å¾Œå‹•ç•«é‡æ–°æ’­æ”¾)
                    marqueeContent.style.animation = 'none';
                    void marqueeContent.offsetWidth; // è§¸ç™¼é‡ç¹ª/é‡æ’
                    marqueeContent.style.animation = 'marquee 20s linear infinite';
                } else {
                    noteMarqueeDiv.style.display = 'none';
                    marqueeContent.style.animation = 'none'; // åœæ­¢å‹•ç•«
                }
            }
            
            // è¼‰å…¥æ™‚åˆå§‹åŒ–è·‘é¦¬ç‡ˆ
            updateMarquee(initialNote);


            // ... (å…¶ä»– DOMContentLoaded å…§çš„åŸæœ‰é‚è¼¯ï¼Œä¾‹å¦‚æŒ‰éˆ•äº‹ä»¶ã€Plotly åˆå§‹åŒ–ç­‰) ...

            // ------------------ æœ€æ„›æŒ‰éˆ•é‚è¼¯ (æ²¿ç”¨ä¸Šæ¬¡ä¿®æ­£) ------------------
            let isFavorite = {{ 'true' if is_favorite else 'false' }};
            const stockId = "{{ stock_id }}";
            const stockName = "{{ stock_id }}"; 

            function updateFavoriteButton() {
                if (isFavorite) {
                    favoriteBtn.style.backgroundColor = 'green';
                    favoriteBtn.style.color = 'white';
                    favoriteBtn.textContent = 'â­ å·²åŠ å…¥æœ€æ„›';
                } else {
                    favoriteBtn.style.backgroundColor = '#ffd700';
                    favoriteBtn.style.color = 'black';
                    favoriteBtn.textContent = 'â­ åŠ å…¥æœ€æ„›';
                }
            }
            updateFavoriteButton();
            
            async function performFavoriteAction() {
                try {
                    const newNote = noteInput.value.trim();
                    let bodyData = `stock_id=${encodeURIComponent(stockId)}&stock_name=${encodeURIComponent(stockName)}`;
                    
                    bodyData += `&note=${encodeURIComponent(newNote)}`;

                    const res = await fetch("/favorite", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: bodyData
                    });
                    
                    const data = await res.json();
                    
                    if (data.favorite !== undefined) {
                        isFavorite = data.favorite;
                        updateFavoriteButton();
                        alert(data.message);
                        
                        // ğŸŒŸ æ ¹æ“šæ“ä½œçµæœæ›´æ–°å‰ç«¯
                        if (isFavorite) {
                             // å¦‚æœæ˜¯æ–°å¢/æ›´æ–°
                             noteInput.value = newNote; // æ›´æ–°è¼¸å…¥æ¡†
                             updateMarquee(newNote);    // æ›´æ–°è·‘é¦¬ç‡ˆ
                        } else {
                            // å¦‚æœæ˜¯ç§»é™¤
                            noteInput.value = '';
                            updateMarquee('');          // æ¸…ç©ºè·‘é¦¬ç‡ˆ
                        }
                    } else {
                         alert(`æ“ä½œå¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }
                } catch (e) {
                    alert("æ“ä½œæœ€æ„›å¤±æ•— (ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤)");
                    console.error(e);
                }
            }
            
            favoriteBtn.addEventListener("click", performFavoriteAction);
            
            // ... (å…¶ä»–åˆå§‹åŒ–é‚è¼¯ï¼Œä¾‹å¦‚ç¹ªåœ–è¨­ç½®ã€æ‡¸åœé‚è¼¯ç­‰ï¼Œè«‹ç¢ºä¿å®Œæ•´è¤‡è£½æ‚¨ä¹‹å‰çš„ä»£ç¢¼) ...
            
        });
    </script>
    
    <script>
        // é€™è£¡æ‡‰è©²åŒ…å«æ‚¨ä¸Šæ¬¡æä¾›çš„ç¹ªåœ–ã€å‡ç·šã€æ¸…é™¤ã€æ‡¸åœç­‰é‚è¼¯ï¼Œä»¥ä¿æŒåŠŸèƒ½å®Œæ•´æ€§ã€‚
        function updateDrawSettings() {
            const color = document.getElementById("lineColor").value;
            const width = parseInt(document.getElementById("lineWidth").value);
            const gd = document.querySelector(".plotly-graph-div");
            Plotly.relayout(gd, {
                'newshape.line.color': color,
                'newshape.line.width': width
            });
        }
        // ... (å…¶ä»–è¼”åŠ©å‡½æ•¸) ...
        
    </script>

</body>
</html>