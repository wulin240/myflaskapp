<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>{{ stock_id }} Kç·šåœ–</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* --- CSS æ¨£å¼ --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #ffffff;
            color: #333;
        }

        .header {
            text-align: center;
            padding: 15px 10px;
            background-color: #f0f0f0;
            border-bottom: 2px solid #ddd;
        }

        .header h2 {
            margin: 0;
            color: #0056b3;
        }

        /* ğŸŒŸ æ–°å¢/ä¿®æ”¹ï¼šé ‚éƒ¨ä¿¡è™Ÿé¡¯ç¤ºå€å¡Šæ¨£å¼ */
        #signalDisplay {
            text-align: center;
            padding: 15px 10px; /* å¢åŠ å…§é‚Šè· */
            background-color: #fefefe;
            border-bottom: 1px solid #ddd;
            font-size: 1.1em; /* æ”¾å¤§æ–‡å­— */
            line-height: 1.8;
            font-weight: 500;
        }

        #signalDisplay strong {
            color: #555;
            font-size: 1.05em; /* è¶¨å‹¢åˆ†æ/ä¿¡è™Ÿæª¢æŸ¥æ¨™ç±¤ç¨å¾®æ”¾å¤§ */
        }
        /* End æ–°å¢/ä¿®æ”¹ */

        .chart-container {
            padding: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x pan-y;
        }

        .chart-inner {
            min-width: 900px;
            width: 100%;
        }

        a {
            text-decoration: none;
            color: #007bff;
            transition: color 0.3s;
        }

        a:hover {
            color: #0056b3;
        }

        .control-panel {
            padding: 8px 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            gap: 10px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .draw-panel {
            background: rgba(240, 240, 240, 0.9);
            padding: 5px;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        select,
        input[type="number"],
        button {
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        .control-group button {
            background-color: #e9e9e9;
        }

        /* ------------------- è³‡è¨Šé¡¯ç¤ºå€å¡Š ------------------- */
        #hoverInfo {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 8px 12px;
            border-radius: 5px;
            display: none;
            font-size: 14px;
            pointer-events: none;
            z-index: 20;
            line-height: 1.5;
        }

        #stockIndexDisplay {
            position: absolute;
            top: 70px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 15;
        }

        #favoriteBtn {
            padding: 6px 12px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            background-color: #ffd700;
        }

        /* ------------------- è¶¨å‹¢ä¿¡è™Ÿæ¨£å¼ ------------------- */
        /* ğŸŒŸ æ ¸å¿ƒæ¨£å¼å®šç¾©ï¼šç¢ºä¿é€™äº›åç¨±èˆ‡å¾Œç«¯ trend_class çš„å€¼å®Œå…¨åŒ¹é… */
        .bullish {
            color: #d9534f; /* ç´…è‰² - çœ‹æ¼² */
            font-weight: bold;
        }

        .bearish {
            color: #5cb85c; /* ç¶ è‰² - çœ‹è·Œ */
            font-weight: bold;
        }

        .neutral {
            color: #5bc0de; /* è—è‰² - ä¸­æ€§ */
        }

        /* é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0%, 100% {
                background-color: #fff3cd;
                color: #856404;
                box-shadow: 0 0 5px rgba(255, 204, 0, 0.8);
            }
            50% {
                background-color: transparent;
                color: inherit;
                box-shadow: none;
            }
        }

        .flashing {
            animation: blink 1.5s linear infinite;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>{{ stock_id }} Kç·šåœ–</h2>
        <a href="/">è¿”å›é¦–é </a>
    </div>

    <div id="stockIndexDisplay"></div>
    
    <div id="signalDisplay">
        <strong>è¶¨å‹¢åˆ†æ:</strong>
        <span id="trendDesc" class="{{ trend_class }}">{{ trend_desc | safe }}</span><br>
        <strong>ä¿¡è™Ÿæª¢æŸ¥:</strong>
        <span id="reboundDesc">{{ rebound_desc | safe }}</span>
    </div>

    <div class="control-panel">

        <div class="control-group">
            <button id="prevStock" style="background:#ddd;">â¬…ï¸ ä¸Šä¸€ç­†</button>
            <button id="nextStock" style="background:#ddd;">ä¸‹ä¸€ç­† â¡ï¸</button>
            <button id="favoriteBtn">â­ åŠ å…¥æœ€æ„›</button>
        </div>

        <div class="control-group">
            <label for="frequencySelect">é€±æœŸ:</label>
            <select id="frequencySelect" onchange="changeFrequency(this.value)">
                <option value="D" {% if frequency == 'D' %}selected{% endif %}>æ—¥ç·š (D)</option>
                <option value="W" {% if frequency == 'W' %}selected{% endif %}>é€±ç·š (W)</option>
            </select>

            {% for n in [30,60,90,120] %}
            <button onclick="changeNumRows({{ n }})" {% if num_rows == n %}style="background-color:#c0c0ff"{% endif %}>{{ n }} ç­†</button>
            {% endfor %}
        </div>

        <div class="draw-panel">
            ç·šæ¢é¡è‰²ï¼š
            <select id="lineColor">
                <option value="red" selected>ç´…</option>
                <option value="blue">è—</option>
                <option value="green">ç¶ </option>
                <option value="black">é»‘</option>
            </select>
            ç·šå¯¬ï¼š
            <input type="number" id="lineWidth" value="2" min="1" max="10" style="width:40px;">
            <button onclick="updateDrawSettings()">æ›´æ–°</button>
            <button id="toggleDraw" style="background:#c0ffc0;">ğŸ“± é—œé–‰ç•«ç­†</button>
            <button id="toggleMA" style="background:#ddd;">åˆ‡æ›å‡ç·šé¡¯ç¤º</button>
            <button id="clearDraw" style="background:#ffdddd;">ğŸ§¹ æ¸…é™¤ç¹ªåœ–</button>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-inner">
            {{ chart_html | safe }}
        </div>
    </div>

    <div id="hoverInfo"></div>

    <script>
        // å¾ Flask ç²å–è®Šæ•¸
        const stockList = "{{ stock_list }}".split(',');
        let currentIndex = parseInt("{{ current_index }}");
        let currentNumRows = parseInt("{{ num_rows }}");
        let simpleMode = "{{ '1' if simple_mode else '0' }}";
        let currentFrequency = "{{ frequency }}";
        let trendDescText = "{{ trend_desc | safe }}".trim();
        let reboundDescText = "{{ rebound_desc | safe }}".trim();
        let trendClass = "{{ trend_class }}"; // ç²å– trend_class

        // ---------------------- æ ¸å¿ƒå°èˆªå‡½æ•¸ (ä¸è®Š) ----------------------
        function buildUrl(stockId, index, numRows, simpleMode, frequency) {
            const listParam = stockList.join(',');
            let url = `/chart/${stockId}?num_rows=${numRows}&simple_mode=${simpleMode}&frequency=${frequency}`;
            if (listParam) {
                url += `&list=${listParam}&index=${index}`;
            }
            return url;
        }

        function changeFrequency(newFreq) {
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                newFreq
            );
        }

        function changeNumRows(n) {
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                n,
                simpleMode,
                currentFrequency
            );
        }

        document.getElementById("prevStock").addEventListener("click", () => {
            if (currentIndex > 0) currentIndex--;
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                currentFrequency
            );
        });

        document.getElementById("nextStock").addEventListener("click", () => {
            if (currentIndex < stockList.length - 1) currentIndex++;
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                currentFrequency
            );
        });

        // ----------- ç•«ç­† & å‡ç·š & æ¸…é™¤ (ä¸è®Š) -----------
        let penEnabled = true;

        function updateDrawSettings() {
            const color = document.getElementById("lineColor").value;
            const width = parseInt(document.getElementById("lineWidth").value);
            const gd = document.querySelector(".plotly-graph-div");
            Plotly.relayout(gd, {
                'newshape.line.color': color,
                'newshape.line.width': width
            });
        }

        function toggleMA() {
            const gd = document.querySelector(".plotly-graph-div");
            let maVisible = localStorage.getItem("maVisible");
            if (maVisible === null) maVisible = 'true';
            maVisible = maVisible === 'true' ? 'false' : 'true';
            localStorage.setItem("maVisible", maVisible);

            const updates = [];
            const indicesToUpdate = [];

            gd.data.forEach((trace, i) => {
                if (trace.name && (trace.name.includes('MA') || trace.name.includes('æ­¢æ'))) {
                    const visible = maVisible === 'true' ? true : 'legendonly';
                    updates.push({ 'visible': visible });
                    indicesToUpdate.push(i);
                }
            });

            if (updates.length > 0) {
                 Plotly.restyle(gd, updates, indicesToUpdate);
            }
        }

        function clearDrawings() {
            const gd = document.querySelector(".plotly-graph-div");
            Plotly.relayout(gd, {
                'shapes': []
            });
        }

        // ğŸŒŸ ç°¡åŒ–å¾Œçš„æ¨£å¼æ‡‰ç”¨ï¼šåƒ…ä¿ç•™ä¿¡è™Ÿé–ƒçˆï¼Œå› ç‚ºè¶¨å‹¢é¡è‰²å·²ç”± HTML ç›´æ¥è¨­å®šã€‚
        function applySignalStyles() {
            const reboundSpan = document.getElementById("reboundDesc");

            // æ¸…é™¤èˆŠçš„é¡åˆ¥
            reboundSpan.classList.remove('flashing');
            reboundSpan.style.backgroundColor = 'transparent';
            reboundSpan.style.color = 'inherit';
            
            // ä¿¡è™Ÿé–ƒçˆåˆ¤æ–·
            if (reboundDescText.includes('èµ·æ¼²ä¿¡è™Ÿ') || reboundDescText.includes('æ½›åœ¨èµ·æ¼²æç¤º') || reboundDescText.includes('è²·å…¥')) {
                reboundSpan.classList.add('flashing');
            }
        }


        // ----------- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ (ä¸è®Š) -----------
        document.addEventListener("DOMContentLoaded", function () {
            const gd = document.querySelector(".plotly-graph-div");
            const hoverBox = document.getElementById("hoverInfo");
            const toggleBtn = document.getElementById("toggleDraw");
            const toggleMABtn = document.getElementById("toggleMA");
            const clearBtn = document.getElementById("clearDraw");
            const stockIndexDisplay = document.getElementById("stockIndexDisplay");
            const favoriteBtn = document.getElementById("favoriteBtn");

            toggleMABtn.addEventListener("click", toggleMA);
            clearBtn.addEventListener("click", clearDrawings);

            // åŸ·è¡Œé¡è‰²èˆ‡é–ƒçˆé‚è¼¯ (è¶¨å‹¢é¡è‰²å·²ç”± HTML è¨­å®š)
            applySignalStyles();
            
            // é¡¯ç¤ºç›®å‰ç¬¬å¹¾ç­†
            function updateStockIndexDisplay() {
                stockIndexDisplay.textContent = `${currentIndex+1}/${stockList.length}`;
            }
            if (stockList.length > 1) updateStockIndexDisplay();
            else stockIndexDisplay.style.display = 'none';

            // åˆå§‹åŒ–æ™‚ï¼Œæ ¹æ“š localStorage è¨­å®šå‡ç·šå’Œæ­¢æç·šé¡¯ç¤º
            let maVisible = localStorage.getItem("maVisible");
            if (maVisible === null) maVisible = 'true';
            gd.data.forEach((trace, i) => {
                if (trace.name && (trace.name.includes('MA') || trace.name.includes('æ­¢æ'))) {
                    const visible = maVisible === 'true' ? true : 'legendonly';
                    Plotly.restyle(gd, {
                        'visible': visible
                    }, [i]);
                }
            });

            const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
            if (isMobile) {
                penEnabled = false;
                Plotly.relayout(gd, {
                    dragmode: false
                });
                toggleBtn.textContent = "ğŸ“± é–‹å•Ÿç•«ç­†";
                toggleBtn.style.background = "#ddd";

                toggleBtn.addEventListener("click", () => {
                    penEnabled = !penEnabled;
                    if (penEnabled) {
                        Plotly.relayout(gd, {
                            dragmode: 'drawline'
                        });
                        toggleBtn.textContent = "ğŸ“± é—œé–‰ç•«ç­†";
                        toggleBtn.style.background = "#c0ffc0";
                    } else {
                        Plotly.relayout(gd, {
                            dragmode: false
                        });
                        toggleBtn.textContent = "ğŸ“± é–‹å•Ÿç•«ç­†";
                        toggleBtn.style.background = "#ddd";
                    }
                });

                // è¡Œå‹•è£ç½®ä½¿ç”¨é»æ“Šäº‹ä»¶é¡¯ç¤ºè³‡è¨Š
                gd.on('plotly_click', function (data) {
                    if (!data.points || !data.points.length) return;
                    const pt = data.points[0];
                    const xValue = pt.x || (pt.data.x && pt.data.x[pt.pointIndex]);
                    const yValue = pt.y || (pt.data.y && pt.data.y[pt.pointIndex]);

                    if (xValue && yValue) {
                        hoverBox.innerHTML = `${pt.data.name || ''}<br>æ—¥æœŸ: ${xValue}<br>æ•¸å€¼: ${yValue.toFixed(2)}`;
                    } else {
                        hoverBox.innerHTML = `${pt.data.name || ''}<br>æ•¸æ“šé»è³‡è¨Šä¸å¯ç”¨`;
                    }
                    
                    hoverBox.style.left = (data.event.clientX + 10) + 'px';
                    hoverBox.style.top = (data.event.clientY - 20) + 'px';
                    hoverBox.style.display = 'block';
                    setTimeout(() => hoverBox.style.display = 'none', 2500);
                });

            } else {
                Plotly.relayout(gd, {
                    dragmode: 'drawline'
                }); 

                toggleBtn.addEventListener("click", () => {
                    const currentMode = gd.layout.dragmode;
                    if (currentMode === 'drawline') {
                        Plotly.relayout(gd, {
                            dragmode: 'pan'
                        });
                        toggleBtn.textContent = "ğŸ“± é–‹å•Ÿç•«ç­†";
                        toggleBtn.style.background = "#ddd";
                    } else {
                        Plotly.relayout(gd, {
                            dragmode: 'drawline'
                        });
                        toggleBtn.textContent = "ğŸ“± é—œé–‰ç•«ç­†";
                        toggleBtn.style.background = "#c0ffc0";
                    }
                });

                // æ¡Œé¢è£ç½®ä½¿ç”¨æ‡¸åœäº‹ä»¶é¡¯ç¤ºè³‡è¨Š
                gd.on('plotly_hover', function (data) {
                    if (!data.points || !data.points.length) return;
                    const pt = data.points[0];
                    
                    const xValue = pt.x || (pt.data.x && pt.data.x[pt.pointIndex]);
                    const yValue = pt.y || (pt.data.y && pt.data.y[pt.pointIndex]);

                    if (xValue && yValue) {
                        hoverBox.innerHTML = `${pt.data.name || ''}<br>æ—¥æœŸ: ${xValue}<br>æ•¸å€¼: ${yValue.toFixed(2)}`;
                    } else {
                        hoverBox.innerHTML = `${pt.data.name || ''}<br>æ•¸æ“šé»è³‡è¨Šä¸å¯ç”¨`;
                    }

                    hoverBox.style.left = (data.event.clientX + 10) + 'px';
                    hoverBox.style.top = (data.event.clientY - 20) + 'px';
                    hoverBox.style.display = 'block';
                });
                gd.on('plotly_unhover', function () {
                    hoverBox.style.display = 'none';
                });
            }


            // ----------- æœ€æ„›æŒ‰éˆ•é‚è¼¯ (ä¸è®Š) -----------
            let isFavorite = {{ 'true' if is_favorite else 'false' }};

            function updateFavoriteButton() {
                if (isFavorite) {
                    favoriteBtn.style.backgroundColor = 'green';
                    favoriteBtn.style.color = 'white';
                    favoriteBtn.textContent = 'â­ å·²åŠ å…¥æœ€æ„›';
                } else {
                    favoriteBtn.style.backgroundColor = '#ffd700';
                    favoriteBtn.style.color = 'black';
                    favoriteBtn.textContent = 'â­ åŠ å…¥æœ€æ„›';
                }
            }
            updateFavoriteButton();

            favoriteBtn.addEventListener("click", async () => {
                try {
                    const res = await fetch("/favorite", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `stock_id=${encodeURIComponent("{{ stock_id }}")}&stock_name=${encodeURIComponent("{{ stock_id }}")}`
                    });
                    const data = await res.json();
                    if (data.favorite !== undefined) isFavorite = data.favorite;
                    updateFavoriteButton();
                    alert(data.message);
                } catch (e) {
                    alert("æ“ä½œæœ€æ„›å¤±æ•—");
                    console.error(e);
                }
            });
        });
    </script>

</body>
</html>