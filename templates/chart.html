<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>{{ stock_id }} Kç·šåœ–</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* --- CSS æ¨£å¼éƒ¨åˆ† --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #ffffff;
            color: #333;
        }

        /* ğŸŒŸ ä¿®æ”¹: ä½¿ç”¨ Flexbox æ’ç‰ˆï¼Œè®“æ¨™é¡Œå’Œåˆ†æä¿¡è™Ÿä¸¦åˆ— */
        .header {
            padding: 10px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
            display: flex; /* å•Ÿç”¨ Flexbox */
            flex-direction: column; /* é è¨­ç‚ºå‚ç›´å †ç–Š */
            align-items: center; /* æ¨™é¡Œå±…ä¸­ */
            text-align: center;
        }

        /* è®“æ¨™é¡Œå’Œè¿”å›é¦–é é€£çµæ©«å‘æ’ç‰ˆ */
        .header h2 {
            margin: 0;
        }

        .header > a {
            margin-bottom: 5px;
        }

        .chart-container {
            padding: 10px 20px; /* å¢åŠ é ‚éƒ¨é–“è· */
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x pan-y;
        }

        .chart-inner {
            min-width: 900px;
            width: 100%;
        }

        a {
            text-decoration: none;
            color: #007bff;
        }

        .control-panel {
            padding: 5px 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œä»¥é©æ‡‰å°è¢å¹• */
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            gap: 8px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .draw-panel {
            background: rgba(240, 240, 240, 0.9);
            padding: 5px;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        select,
        input[type="number"],
        button {
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        #hoverInfo {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 8px 12px;
            border-radius: 5px;
            display: none;
            font-size: 14px;
            pointer-events: none;
            z-index: 20;
        }

        #stockIndexDisplay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 15;
        }

        #favoriteBtn {
            padding: 6px 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        /* è¶¨å‹¢ä¿¡è™Ÿé¡è‰²æ¨£å¼ (ä¿ç•™æ‚¨çš„æœ‰æ•ˆæ¨£å¼) */
        .bullish {
            color: red;
            font-weight: bold;
        }

        .bearish {
            color: green;
            font-weight: bold;
        }

        .neutral {
            color: gray;
        }

        /* é–ƒçˆå‹•ç•« (ä¿ç•™æ‚¨çš„æœ‰æ•ˆæ¨£å¼) */
        @keyframes blink {
            0% { background-color: yellow; color: black; }
            50% { background-color: transparent; color: inherit; }
            100% { background-color: yellow; color: black; }
        }

        .flashing {
            animation: blink 1.5s linear infinite;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* ğŸŒŸ ä¿®æ”¹: ç§»é™¤ä¸å¿…è¦çš„ border/marginï¼Œä½¿å…¶èå…¥ header */
        #signalDisplay {
            text-align:center;
            padding: 5px 0 0 0; /* èª¿æ•´å…§é‚Šè· */
            font-size: 15px;
        }
        
        /* ------------------- ğŸŒŸ æ•´åˆä¾†æº: è·‘é¦¬ç‡ˆå°ˆç”¨ CSS ------------------- */
        #noteMarquee {
            background-color: #ffeaa7; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
            color: #333;
            padding: 5px 10px;
            font-size: 16px; /* ğŸŒŸ å­—é«”åŠ å¤§ */
            border-bottom: 1px solid #f9d863;
            overflow: hidden; /* éš±è—è¶…å‡ºå®¹å™¨çš„å…§å®¹ */
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative; /* ç”¨æ–¼å®šä½å‹•ç•«å…§å®¹ */
            height: 30px; /* ç¢ºä¿é«˜åº¦è¶³å¤  */
            line-height: 20px;
        }

        #marqueeContent {
            display: inline-block;
            white-space: nowrap;
            position: absolute; /* ç›¸å°æ–¼çˆ¶å®¹å™¨å®šä½ */
            padding-left: 100%; /* è®“å…§å®¹å¾æœ€å³é‚Šé–‹å§‹ */
            /* æ‡‰ç”¨ CSS è·‘é¦¬ç‡ˆå‹•ç•« */
            animation: marquee 20s linear infinite; /* 20ç§’è·‘å®Œä¸€åœˆï¼Œç„¡é™å¾ªç’° */
        }

        #marqueeContent span {
            font-weight: bold;
            color: #d35400; /* çªé¡¯å‚™è¨»æ¨™ç±¤ */
            margin-right: 15px;
            font-size: 1.1em; /* è®“æ¨™ç±¤æ›´æ˜é¡¯ */
        }

        /* CSS è·‘é¦¬ç‡ˆå‹•ç•«å®šç¾© */
        @keyframes marquee {
            0% { transform: translate(0, 0); } /* å¾æœ€å³é‚Šé–‹å§‹ (å› ç‚º padding-left: 100%) */
            100% { transform: translate(-100%, 0); } /* æ»¾å‹•åˆ°æœ€å·¦é‚Š */
        }
        /* ------------------- ğŸŒŸ æ•´åˆä¾†æº: è·‘é¦¬ç‡ˆå°ˆç”¨ CSS END ------------------- */

        /* æ•´åˆä¾†æº: å‚™è¨»è¼¸å…¥æ¡†çš„æ¨£å¼ */
        #noteGroup {
            flex-grow: 1;
            max-width: 400px;
            min-width: 200px;
        }
        #noteInput {
            flex-grow: 1;
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

    </style>
</head>
<body>

    <div class="header">
        <h2>{{ stock_id }} Kç·šåœ–</h2>
        <a href="/">è¿”å›é¦–é </a>

        <div id="signalDisplay">
            <strong>è¶¨å‹¢åˆ†æ:</strong>
            <span id="trendDesc" class="{{ trend_class }}">{{ trend_desc | safe }}</span><br>
            <strong>ä¿¡è™Ÿæª¢æŸ¥:</strong>
            <span id="reboundDesc">{{ rebound_desc | safe }}</span>
        </div>
    </div>
    
    <div id="noteMarquee" style="display: none;">
        <div id="marqueeContent">
        </div>
    </div>

    <div id="stockIndexDisplay"></div>

    <div class="control-panel">

        <div class="control-group">
            <button id="prevStock" style="background:#ddd;">â¬…ï¸ ä¸Šä¸€ç­†</button>
            <button id="nextStock" style="background:#ddd;">ä¸‹ä¸€ç­† â¡ï¸</button>
            <button id="favoriteBtn">â­ åŠ å…¥æœ€æ„›</button>
        </div>

        <div class="control-group" id="noteGroup">
            <label for="noteInput" style="white-space: nowrap;">å‚™è¨»:</label>
            <input type="text" id="noteInput" placeholder="è¼¸å…¥å‚™è¨»ï¼Œå„²å­˜å¾Œè‡ªå‹•å¯«å…¥" value="{{ favorite_note | default('') }}">
        </div>

        <div class="control-group">
            <label for="frequencySelect">é€±æœŸ:</label>
            <select id="frequencySelect" onchange="changeFrequency(this.value)">
                <option value="D" {% if frequency == 'D' %}selected{% endif %}>æ—¥ç·š (D)</option>
                <option value="W" {% if frequency == 'W' %}selected{% endif %}>é€±ç·š (W)</option>
            </select>

            {% for n in [30,60,90,120] %}
            <button onclick="changeNumRows({{ n }})" {% if num_rows == n %}style="background-color:#c0c0ff"{% endif %}>{{ n }} ç­†</button>
            {% endfor %}
        </div>

        <div class="draw-panel">
            ç·šæ¢é¡è‰²ï¼š
            <select id="lineColor">
                <option value="red" selected>ç´…</option>
                <option value="blue">è—</option>
                <option value="green">ç¶ </option>
                <option value="black">é»‘</option>
            </select>
            ç·šå¯¬ï¼š
            <input type="number" id="lineWidth" value="2" min="1" max="10" style="width:40px;">
            <button onclick="updateDrawSettings()">æ›´æ–°</button>
            <button id="toggleDraw" style="background:#c0ffc0;">ğŸ“± é—œé–‰ç•«ç­†</button>
            <button id="toggleMA" style="background:#ddd;">åˆ‡æ›å‡ç·šé¡¯ç¤º</button>
            <button id="clearDraw" style="background:#ffdddd;">ğŸ§¹ æ¸…é™¤ç¹ªåœ–</button>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-inner">
            {{ chart_html | safe }}
        </div>
    </div>

    <div id="hoverInfo"></div>

    <script>
        // å¾ Flask ç²å–è®Šæ•¸
        const stockList = "{{ stock_list }}".split(',');
        let currentIndex = parseInt("{{ current_index }}");
        let currentNumRows = parseInt("{{ num_rows }}");
        let simpleMode = "{{ '1' if simple_mode else '0' }}";
        let currentFrequency = "{{ frequency }}";
        // ç¢ºä¿å–åˆ°çš„å­—ä¸²å·²ç§»é™¤ä¸å¿…è¦çš„ HTML è½‰ç¾©å­—å…ƒ
        let trendDescText = "{{ trend_desc | safe }}".trim();
        let reboundDescText = "{{ rebound_desc | safe }}".trim();
        let trendClass = "{{ trend_class }}";
        
        let penEnabled = true;
        
        // ğŸŒŸ æ•´åˆä¾†æº: ç²å–å¾Œç«¯å‚³ä¾†çš„å‚™è¨»
        const initialNote = "{{ favorite_note | default('') }}";


        // ---------------------- æ ¸å¿ƒå°èˆªå‡½æ•¸ (ä¸è®Š) ----------------------
        function buildUrl(stockId, index, numRows, simpleMode, frequency) {
            const listParam = stockList.join(',');
            let url = `/chart/${stockId}?num_rows=${numRows}&simple_mode=${simpleMode}&frequency=${frequency}`;
            if (listParam) {
                url += `&list=${listParam}&index=${index}`;
            }
            return url;
        }

        function changeFrequency(newFreq) {
            window.location.href = buildUrl(
                stockList[currentIndex],
                currentIndex,
                currentNumRows,
                simpleMode,
                newFreq
            );
        }

       function changeNumRows(n) {
 window.location.href = buildUrl(
 stockList[currentIndex],
 currentIndex,
n, // **ä¿®æ­£ï¼šä½¿ç”¨å‚³å…¥çš„æ–°ç­†æ•¸ n**
 simpleMode,
 currentFrequency
 );
 }
        
        // ----------- ç•«ç­† & å‡ç·š & æ¸…é™¤ (å„ªåŒ–æŒ‰éˆ•é¡è‰²æ›´æ–°) -----------

        function updateDrawSettings() {
            const color = document.getElementById("lineColor").value;
            const width = parseInt(document.getElementById("lineWidth").value);
            const gd = document.querySelector(".plotly-graph-div");
            if(!gd) return;
            Plotly.relayout(gd, {
                'newshape.line.color': color,
                'newshape.line.width': width
            });
        }

        /**
         * ğŸŒŸ å„ªåŒ–å¾Œçš„ toggleMA å‡½æ•¸ï¼šåˆ‡æ›å‡ç·šå’Œæ­¢æç·šçš„é¡¯ç¤º/éš±è—ç‹€æ…‹ï¼Œä¸¦æ›´æ–°æŒ‰éˆ•é¡è‰²ã€‚
         */
        function toggleMA() {
            const gd = document.querySelector(".plotly-graph-div");
            const toggleMABtn = document.getElementById("toggleMA");
            if(!gd) return;
            
            let maVisible = localStorage.getItem("maVisible");
            if (maVisible === null) maVisible = 'true';
            
            // åˆ‡æ›ç‹€æ…‹
            maVisible = maVisible === 'true' ? 'false' : 'true';
            localStorage.setItem("maVisible", maVisible);

            // æ±ºå®šæ–°çš„ visible å±¬æ€§
            const visible = maVisible === 'true' ? true : 'legendonly';

            gd.data.forEach((trace, i) => {
                // æª¢æŸ¥ MAã€æ­¢æç·šã€VWAPï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (trace.name && (trace.name.includes('MA') || trace.name.includes('æ­¢æ') || trace.name.includes('VWAP'))) {
                    Plotly.restyle(gd, {
                        'visible': visible
                    }, [i]);
                }
            });
            
            // ğŸŒŸ æ›´æ–°æŒ‰éˆ•é¡è‰²: éš±è—æ™‚é¡¯ç¤ºç²‰ç´…æç¤ºè‰²
            toggleMABtn.style.background = maVisible === 'true' ? '#ddd' : '#ffc0cb';
        }

        function clearDrawings() {
            const gd = document.querySelector(".plotly-graph-div");
            if(!gd) return;
            Plotly.relayout(gd, {
                'shapes': []
            });
        }

        // è¶¨å‹¢ä¿¡è™Ÿé–ƒçˆé‚è¼¯ (ä¾†è‡ªæ‚¨çš„æœ‰æ•ˆç‰ˆæœ¬)
        function applySignalStyles() {
            const reboundSpan = document.getElementById("reboundDesc");
            reboundSpan.classList.remove('flashing');
            reboundSpan.style.backgroundColor = 'transparent';
            reboundSpan.style.color = 'inherit';

            // åˆ¤æ–·æ˜¯å¦éœ€è¦é–ƒçˆ
            if (reboundDescText.includes('èµ·æ¼²ä¿¡è™Ÿ') || reboundDescText.includes('æ½›åœ¨èµ·æ¼²æç¤º') || reboundDescText.includes('è²·å…¥')) {
                reboundSpan.classList.add('flashing');
            }
        }


        // ----------- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ -----------
        document.addEventListener("DOMContentLoaded", function () {
            const gd = document.querySelector(".plotly-graph-div");
            const hoverBox = document.getElementById("hoverInfo");
            const toggleBtn = document.getElementById("toggleDraw");
            const toggleMABtn = document.getElementById("toggleMA");
            const clearBtn = document.getElementById("clearDraw");
            const stockIndexDisplay = document.getElementById("stockIndexDisplay");
            const favoriteBtn = document.getElementById("favoriteBtn");
            // ğŸŒŸ æ•´åˆä¾†æº: ç²å–å‚™è¨»å’Œè·‘é¦¬ç‡ˆå…ƒç´ 
            const noteInput = document.getElementById("noteInput");
            const noteMarqueeDiv = document.getElementById("noteMarquee");
            const marqueeContent = document.getElementById("marqueeContent");

            if (!gd) return; // å¦‚æœåœ–è¡¨å…ƒç´ ä¸å­˜åœ¨ï¼Œå‰‡åœæ­¢åŸ·è¡Œ

            // å°èˆªæŒ‰éˆ•ç›£è½ (æ²¿ç”¨æ‚¨çš„é‚è¼¯)
            document.getElementById("prevStock").addEventListener("click", () => {
                if (currentIndex > 0) currentIndex--;
                window.location.href = buildUrl(stockList[currentIndex], currentIndex, currentNumRows, simpleMode, currentFrequency);
            });

            document.getElementById("nextStock").addEventListener("click", () => {
                if (currentIndex < stockList.length - 1) currentIndex++;
                window.location.href = buildUrl(stockList[currentIndex], currentIndex, currentNumRows, simpleMode, currentFrequency);
            });

            // åŠŸèƒ½æŒ‰éˆ•ç›£è½
            toggleMABtn.addEventListener("click", toggleMA);
            clearBtn.addEventListener("click", clearDrawings);
            
            // åŸ·è¡Œä¿¡è™Ÿé–ƒçˆé‚è¼¯
            applySignalStyles();
            
            // é¡¯ç¤ºç›®å‰ç¬¬å¹¾ç­†
            function updateStockIndexDisplay() {
                stockIndexDisplay.textContent = `${currentIndex+1}/${stockList.length}`;
            }
            if (stockList.length > 1) updateStockIndexDisplay();
            else stockIndexDisplay.style.display = 'none';

            // ------------------------------------------------
            // ğŸŒŸ å‡ç·šåˆå§‹åŒ–ï¼šç¢ºä¿åœ–è¡¨è¼‰å…¥æ™‚ï¼Œç‹€æ…‹èˆ‡ localStorage åŒæ­¥ (ä¿ç•™ç›®æ¨™é‚è¼¯)
            // ------------------------------------------------
            let maVisible = localStorage.getItem("maVisible");
            if (maVisible === null) maVisible = 'true';
            
            const initialVisible = maVisible === 'true' ? true : 'legendonly';
            toggleMABtn.style.background = maVisible === 'true' ? '#ddd' : '#ffc0cb'; // åˆå§‹æŒ‰éˆ•é¡è‰²

            // ç”±æ–¼æ‚¨çš„åœ–è¡¨æ˜¯é€šé Flask æ¸²æŸ“çš„ Plotly.jsï¼Œ
            // åˆå§‹ Plotly.restyle å¯ä»¥åœ¨ DOMContentLoaded å…§é€²è¡Œï¼Œå› ç‚ºåœ–è¡¨æ•¸æ“šå·²åµŒå…¥ã€‚
            gd.data.forEach((trace, i) => {
                if (trace.name && (trace.name.includes('MA') || trace.name.includes('æ­¢æ') || trace.name.includes('VWAP'))) {
                    Plotly.restyle(gd, {
                        'visible': initialVisible
                    }, [i]);
                }
            });

            // ------------------------------------------------
            // ğŸŒŸ ç•«ç­†/æ‹–æ›³æ¨¡å¼é‚è¼¯ (ä¿ç•™ç›®æ¨™é‚è¼¯)
            // ------------------------------------------------
            const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
            
            const drawModeToggle = () => {
                
                // æ±ºå®šæ–°çš„ç‹€æ…‹
                penEnabled = !penEnabled; 
                
                // æ±ºå®šæ–°çš„æ‹–æ›³æ¨¡å¼
                let newDragMode = false;
                if (isMobile) {
                    newDragMode = penEnabled ? 'drawline' : false;
                } else {
                    // é Mobile æ¨¡å¼ä¸‹ï¼Œé—œé–‰ç•«ç­†æ‡‰åˆ‡æ›åˆ° 'pan' (å¹³ç§»/ç¸®æ”¾)
                    newDragMode = penEnabled ? 'drawline' : 'pan';
                }

                // åŸ·è¡Œåˆ‡æ›
                Plotly.relayout(gd, { dragmode: newDragMode });

                // æ›´æ–°æŒ‰éˆ•æ¨£å¼å’Œæ–‡å­—
                if (penEnabled) {
                    toggleBtn.textContent = "ğŸ“± é—œé–‰ç•«ç­†";
                    toggleBtn.style.background = "#c0ffc0";
                } else {
                    toggleBtn.textContent = "ğŸ“± é–‹å•Ÿç•«ç­†";
                    toggleBtn.style.background = "#ddd";
                }
            };

            // åˆå§‹åŒ–ç•«ç­†ç‹€æ…‹
            if (isMobile) {
                // Mobile: é è¨­é—œé–‰ç•«ç­†
                penEnabled = false;
                Plotly.relayout(gd, { dragmode: false });
                toggleBtn.textContent = "ğŸ“± é–‹å•Ÿç•«ç­†";
                toggleBtn.style.background = "#ddd";
                
                // Mobile: ä½¿ç”¨ click äº‹ä»¶é¡¯ç¤º hover info
                gd.on('plotly_click', function (data) {
                    if (!data.points || !data.points.length) return;
                    const pt = data.points[0];
                    hoverBox.innerHTML = `${pt.data.name || ''}<br>${pt.x}<br>${pt.y}`;
                    hoverBox.style.left = (data.event.clientX + 10) + 'px';
                    hoverBox.style.top = (data.event.clientY - 20) + 'px';
                    hoverBox.style.display = 'block';
                    setTimeout(() => hoverBox.style.display = 'none', 2500);
                });

            } else {
                // Desktop: é è¨­é–‹å•Ÿç•«ç­†
                penEnabled = true;
                Plotly.relayout(gd, { dragmode: 'drawline' }); 
                toggleBtn.textContent = "ğŸ“± é—œé–‰ç•«ç­†";
                toggleBtn.style.background = "#c0ffc0";
                
                // Desktop: ä½¿ç”¨ hover äº‹ä»¶é¡¯ç¤º hover info
                gd.on('plotly_hover', function (data) {
                    const pt = data.points[0];
                    hoverBox.innerHTML = `${pt.data.name || ''}<br>${pt.x}<br>${pt.y}`;
                    hoverBox.style.left = (data.event.clientX + 10) + 'px';
                    hoverBox.style.top = (data.event.clientY - 20) + 'px';
                    hoverBox.style.display = 'block';
                });
                gd.on('plotly_unhover', function () {
                    hoverBox.style.display = 'none';
                });
            }
            
            // çµ±ä¸€ç¶å®šç•«ç­†æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            toggleBtn.addEventListener("click", drawModeToggle);

            
            // ------------------ ğŸŒŸ æ•´åˆä¾†æº: è·‘é¦¬ç‡ˆåˆå§‹åŒ–åŠæ›´æ–°å‡½æ•¸ ------------------
            function updateMarquee(note) {
                const trimmedNote = note.trim();
                if (trimmedNote.length > 0) {
                    // ğŸŒŸ æ³¨æ„ï¼šæˆ‘å€‘å°‡æ•´å€‹å…§å®¹æ”¾å…¥ marqueeContent ä¸­
                    marqueeContent.innerHTML = `<span>æˆ‘çš„å‚™è¨»:</span> ${trimmedNote}`;
                    noteMarqueeDiv.style.display = 'block';
                    // é‡æ–°æ‡‰ç”¨å‹•ç•« (ç‚ºäº†ç¢ºä¿åœ¨å…§å®¹æ›´æ–°å¾Œå‹•ç•«é‡æ–°æ’­æ”¾)
                    marqueeContent.style.animation = 'none';
                    void marqueeContent.offsetWidth; // è§¸ç™¼é‡ç¹ª/é‡æ’
                    marqueeContent.style.animation = 'marquee 20s linear infinite';
                } else {
                    noteMarqueeDiv.style.display = 'none';
                    marqueeContent.style.animation = 'none'; // åœæ­¢å‹•ç•«
                }
            }
            
            // è¼‰å…¥æ™‚åˆå§‹åŒ–è·‘é¦¬ç‡ˆ
            updateMarquee(initialNote);


            // ----------- ğŸŒŸ æ•´åˆä¾†æº: æœ€æ„›æŒ‰éˆ•é‚è¼¯ (åŠ å…¥å‚™è¨»åŠŸèƒ½) -----------
            let isFavorite = {{ 'true' if is_favorite else 'false' }};
            const stockId = "{{ stock_id }}";
            const stockName = "{{ stock_id }}"; 

            function updateFavoriteButton() {
                if (isFavorite) {
                    favoriteBtn.style.backgroundColor = 'green';
                    favoriteBtn.style.color = 'white';
                    favoriteBtn.textContent = 'â­ å·²åŠ å…¥æœ€æ„›';
                } else {
                    favoriteBtn.style.backgroundColor = '#ffd700';
                    favoriteBtn.style.color = 'black';
                    favoriteBtn.textContent = 'â­ åŠ å…¥æœ€æ„›';
                }
            }
            updateFavoriteButton();

            async function performFavoriteAction() {
                try {
                    const newNote = noteInput.value.trim();
                    let bodyData = `stock_id=${encodeURIComponent(stockId)}&stock_name=${encodeURIComponent(stockName)}`;
                    
                    // ğŸŒŸ åŠ å…¥å‚™è¨»åˆ° POST è«‹æ±‚ä¸­
                    bodyData += `&note=${encodeURIComponent(newNote)}`;

                    const res = await fetch("/favorite", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: bodyData
                    });
                    
                    const data = await res.json();
                    
                    if (data.favorite !== undefined) {
                        isFavorite = data.favorite;
                        updateFavoriteButton();
                        alert(data.message);
                        
                        // ğŸŒŸ æ ¹æ“šæ“ä½œçµæœæ›´æ–°å‰ç«¯
                        if (isFavorite) {
                                // å¦‚æœæ˜¯æ–°å¢/æ›´æ–°
                                noteInput.value = newNote; // æ›´æ–°è¼¸å…¥æ¡†
                                updateMarquee(newNote);    // æ›´æ–°è·‘é¦¬ç‡ˆ
                        } else {
                            // å¦‚æœæ˜¯ç§»é™¤
                            noteInput.value = '';
                            updateMarquee('');         // æ¸…ç©ºè·‘é¦¬ç‡ˆ
                        }
                    } else {
                            alert(`æ“ä½œå¤±æ•—: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    }
                } catch (e) {
                    alert("æ“ä½œæœ€æ„›å¤±æ•— (ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤)");
                    console.error(e);
                }
            }
            
            // å°‡äº‹ä»¶ç›£è½å™¨æ”¹ç‚ºæ–°çš„å‡½æ•¸
            favoriteBtn.removeEventListener("click", favoriteBtn.clickListener); // ç§»é™¤èˆŠçš„ (å¦‚æœå­˜åœ¨)
            favoriteBtn.addEventListener("click", performFavoriteAction);
            // ------------------ ğŸŒŸ æ•´åˆä¾†æº: æœ€æ„›æŒ‰éˆ•é‚è¼¯ END ------------------


        });
    </script>

</body>
</html>